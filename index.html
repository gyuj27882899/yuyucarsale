<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    
    <title>ç‚®ç‚®ç‹ | å°æ±å¤–ç´„é¦–é¸</title>
    
    <!-- æ¨£å¼åº« -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #1a1a1a; color: #fff; -webkit-tap-highlight-color: transparent; }
        
        /* å¡ç‰‡æ¨£å¼ */
        .profile-card { background-color: #2d2d2d; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .line-btn { background-color: #06C755; transition: 0.2s; }
        .line-btn:active { background-color: #05a045; }

        /* å½ˆçª—æ¨£å¼ */
        #gallery-modal { 
            position: fixed; inset: 0; z-index: 50;
            background-color: rgba(0, 0, 0, 0.98); /* ç´”é»‘èƒŒæ™¯é¿å…å¹²æ“¾ */
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
        }
        
        /* åª’é«”å®¹å™¨ï¼šæ‰‹æ©Ÿç‰ˆæ©«å‘æ»‘å‹•å€ */
        .media-scroll-container {
            width: 100%;
            height: 70vh; /* å›ºå®šé«˜åº¦ */
            display: flex;
            align-items: center;
            overflow-x: auto; 
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            gap: 10px;
            padding: 0 10px;
        }

        /* å–®å€‹åª’é«”é …ç›® */
        .media-item {
            min-width: 100%; /* å¼·åˆ¶æ»¿ç‰ˆ */
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            scroll-snap-align: center;
            position: relative;
        }

        .gallery-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
        }

        /* å½±ç‰‡å®¹å™¨ */
        .video-wrapper {
            width: 100%;
            max-width: 800px;
            height: 100%;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #444;
        }
        
        /* å‡å°é¢ */
        .video-facade {
            position: absolute; inset: 0; z-index: 20;
            cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            background-color: #000;
        }
        .video-facade img { width: 100%; height: 100%; object-fit: contain; opacity: 0.7; }
        
        /* å½±ç‰‡å…§å®¹ */
        .video-content { width: 100%; height: 100%; z-index: 10; }
        iframe { width: 100%; height: 100%; border: none; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">

    <!-- é ‚éƒ¨å°èˆª -->
    <nav class="bg-gray-800 shadow-lg sticky top-0 z-40 border-b border-gray-700 px-4 py-3 flex justify-between items-center">
        <div class="flex items-center space-x-2">
            <i class="fa-solid fa-crown text-2xl text-yellow-500"></i>
            <span class="text-xl font-bold tracking-wider">ç‚®ç‚®ç‹</span>
        </div>
        <a href="#" id="navLineBtn" target="_blank" class="line-btn text-white px-4 py-2 rounded-full text-sm font-bold flex items-center">
            <i class="fa-brands fa-line text-lg mr-2"></i> å®¢æœ
        </a>
    </nav>

    <!-- åˆ—è¡¨å€ -->
    <section class="max-w-6xl mx-auto px-4 py-6 flex-grow">
        <!-- æœå°‹ -->
        <div class="mb-6">
            <input type="text" id="searchInput" placeholder="æœå°‹åå­—ã€é—œéµå­—..." class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-full text-white text-base">
        </div>

        <div id="loading" class="text-center py-10 text-gray-400">
            <i class="fa-solid fa-circle-notch fa-spin text-2xl mb-2"></i><br>è³‡æ–™è®€å–ä¸­...
        </div>
        
        <div id="profiles-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden"></div>
        <div id="no-results" class="hidden text-center py-10 text-gray-500">æŸ¥ç„¡è³‡æ–™</div>
    </section>

    <!-- ç‹€æ…‹å„€è¡¨æ¿ (é™¤éŒ¯ç”¨ï¼Œç¢ºèªè³‡æ–™ç‹€æ³) -->
    <div class="bg-black text-gray-500 text-xs p-2 text-center border-t border-gray-800" id="debug-bar">
        ç³»çµ±æº–å‚™å°±ç·’...
    </div>

    <!-- ç›¸ç°¿å½ˆçª— -->
    <div id="gallery-modal" class="hidden">
        <button onclick="closeGallery()" class="absolute top-4 left-4 text-white z-50 px-4 py-2 bg-gray-800/80 rounded-full flex items-center border border-gray-600">
            <i class="fa-solid fa-arrow-left mr-2"></i> è¿”å›
        </button>

        <h2 id="modal-title" class="text-xl font-bold mb-2 mt-12 text-center px-4"></h2>

        <!-- æ»‘å‹•å®¹å™¨ -->
        <div id="modal-images-container" class="media-scroll-container"></div>

        <div class="w-full max-w-xs px-4 mt-4 pb-4">
            <p class="text-center text-xs text-gray-400 mb-2">å·¦å³æ»‘å‹•æŸ¥çœ‹æ›´å¤š | é»æ“Šæ’­æ”¾å½±ç‰‡</p>
            <a href="#" id="modal-line-btn" target="_blank" class="line-btn w-full py-3 rounded-full text-center font-bold block">
                ç«‹å³ LINE é å®š
            </a>
        </div>
    </div>

    <script>
        // ğŸ‘‡ è¨­å®šå€ ğŸ‘‡
        const myLineId = "ä½ çš„LINE_ID"; 
        const googleSheetCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSnvM52ixrMGKzLTMMleErStxnyRpFlsPuMUlSc2HdNwIbJhgPrz_eDe7xMgbZv4acLBPK5u9JS6r20/pub?gid=1682452717&single=true&output=csv";
        
        let profilesData = [];
        let currentDisplayedData = [];
        const container = document.getElementById('profiles-container');
        const searchInput = document.getElementById('searchInput');
        const modal = document.getElementById('gallery-modal');
        const debugBar = document.getElementById('debug-bar');
        
        document.getElementById('navLineBtn').href = `https://line.me/ti/p/~${myLineId}`;

        // æ™ºæ…§æ¬„ä½è®€å–
        function getValue(item, keys) {
            const allKeys = Object.keys(item);
            for (let targetKey of keys) {
                const foundKey = allKeys.find(k => k.toLowerCase().includes(targetKey.toLowerCase()));
                if (foundKey && item[foundKey]) return item[foundKey].trim();
            }
            return "";
        }

        // ID æå–
        function getDriveId(url) {
            if (!url) return null;
            const cleanUrl = url.split('#')[0].split('?')[0]; 
            let match = cleanUrl.match(/\/d\/([a-zA-Z0-9_-]{25,})/);
            if (match) return match[1];
            match = cleanUrl.match(/id=([a-zA-Z0-9_-]{25,})/);
            if (match) return match[1];
            return null;
        }

        // åœ–ç‰‡é€£çµ
        function convertDriveLink(url) {
            const id = getDriveId(url);
            if (id) return `https://drive.google.com/thumbnail?id=${id}&sz=w1000`; 
            return url || "https://via.placeholder.com/600x800?text=ç„¡åœ–ç‰‡";
        }

        // å½±ç‰‡è¼‰å…¥
        window.loadIframe = function(element, videoId) {
            const contentDiv = element.parentElement.querySelector('.video-content');
            // ä½¿ç”¨ Preview æ¨¡å¼
            contentDiv.innerHTML = `<iframe src="https://drive.google.com/file/d/${videoId}/preview?autoplay=1" allow="autoplay; fullscreen" allowfullscreen></iframe>`;
            element.style.display = 'none';
        }

        function init() {
            debugBar.innerText = "æ­£åœ¨é€£ç·š Google Sheet...";
            if (googleSheetCsvUrl.startsWith('http')) {
                const cacheBuster = (googleSheetCsvUrl.includes('?') ? '&' : '?') + 't=' + new Date().getTime();
                Papa.parse(googleSheetCsvUrl + cacheBuster, {
                    download: true, header: true,
                    complete: function(results) {
                        // è¨ºæ–·æ¬„ä½
                        if(results.data.length > 0) {
                            debugBar.innerText = `è®€å–æˆåŠŸ: ${results.data.length} ç­†ã€‚åµæ¸¬æ¬„ä½: ${Object.keys(results.data[0]).join(', ')}`;
                        }

                        profilesData = results.data.filter(item => {
                            return getValue(item, ['è»Šå', 'åå­—', 'å§“å', 'Name']) !== ""; 
                        });
                        
                        document.getElementById('loading').classList.add('hidden');
                        
                        if (profilesData.length > 0) {
                            container.classList.remove('hidden');
                            currentDisplayedData = profilesData;
                            renderProfiles(profilesData);
                        } else {
                            document.getElementById('no-results').classList.remove('hidden');
                            document.getElementById('no-results').innerHTML = `
                                <div class="p-4 border border-red-500 rounded text-red-400">
                                    è®€å–åˆ°äº† 0 ç­†è³‡æ–™ã€‚<br>è«‹æª¢æŸ¥ Google è¡¨å–®æ˜¯å¦æœ‰ã€Œè»Šåã€æ¬„ä½ï¼Œä¸¦ç¢ºèªæœ‰æäº¤è³‡æ–™ã€‚
                                </div>`;
                        }
                    },
                    error: (err) => {
                        document.getElementById('loading').innerText = "é€£ç·šå¤±æ•—";
                        debugBar.innerText = `éŒ¯èª¤: ${err.message}`;
                    }
                });
            }
        }

        function renderProfiles(data) {
            container.innerHTML = '';
            data.forEach((item, index) => {
                const name = getValue(item, ['è»Šå', 'åå­—', 'å§“å']);
                const age = getValue(item, ['è»Šé½¡', 'å¹´é½¡']) || "--";
                const body = getValue(item, ['è»Šèº«', 'èº«æ']) || "--";
                const origin = getValue(item, ['è»Šç±', 'åœ°é»']) || "å°æ±"; 
                const price = getValue(item, ['è»Šåƒ¹', 'åƒ¹æ ¼']) || "0";
                
                // åœ–ç‰‡
                const rawMainImg = getValue(item, ['MainImage', 'Image', 'image', 'ç…§ç‰‡', 'åœ–ç‰‡', 'ä¸Šå‚³']);
                const firstImg = rawMainImg ? rawMainImg.split(',')[0].trim() : "";
                const mainImg = convertDriveLink(firstImg);
                
                // ç‹€æ…‹
                const status = getValue(item, ['Status', 'ç‹€æ…‹', 'ç›®å‰ç‹€æ…‹', 'å¿™ç¢Œ']).toLowerCase();
                const isBusy = ["busy", "å¿™", "no", "x", "false", "æœ‰äº‹", "é ç´„", "å”®å‡º"].some(k => status.includes(k));
                
                let statusHtml = isBusy 
                    ? '<span class="absolute top-3 left-3 bg-red-600 text-white text-xs font-bold px-3 py-1 rounded shadow-md z-10">å¿™ç¢Œä¸­</span>'
                    : '<span class="absolute top-3 left-3 bg-green-500 text-white text-xs font-bold px-3 py-1 rounded shadow-md z-10">å¯é ç´„</span>';

                const lineMsg = encodeURIComponent(`ä½ å¥½ï¼Œæˆ‘æƒ³é å®šã€Œ${name}ã€ï¼Œæ–¹æ¡ˆ $${price}/40åˆ†é˜`);
                const lineUrl = `https://line.me/ti/p/~${myLineId}?text=${lineMsg}`;

                const cardHtml = `
                    <div class="profile-card group relative">
                        ${statusHtml}
                        <div class="h-80 overflow-hidden relative cursor-pointer" onclick="openGallery(${index})">
                            <img src="${mainImg}" loading="lazy" class="w-full h-full object-cover transition duration-500 group-hover:scale-110" onerror="this.src='https://via.placeholder.com/600x800?text=ç„¡åœ–ç‰‡'">
                            <div class="absolute bottom-0 w-full bg-gradient-to-t from-black to-transparent p-4 pt-12">
                                <h3 class="text-2xl font-bold text-white">${name}</h3>
                            </div>
                        </div>
                        <div class="p-4">
                            <div class="grid grid-cols-2 gap-2 mb-4 text-sm text-gray-300">
                                <div class="bg-gray-800 p-2 rounded text-center">è»Šé½¡: ${age}</div>
                                <div class="bg-gray-800 p-2 rounded text-center">è»Šç±: ${origin}</div>
                                <div class="bg-gray-800 p-2 rounded text-center col-span-2">è»Šèº«: ${body}</div>
                            </div>
                            <div class="flex justify-between items-center mb-4 px-2">
                                <span class="text-sm text-gray-400">åŸºæœ¬æ–¹æ¡ˆ</span>
                                <span class="text-xl font-bold text-yellow-400">$${price}</span>
                            </div>
                            <a href="${lineUrl}" target="_blank" onclick="event.stopPropagation()" class="line-btn w-full text-white font-bold py-3 rounded-lg flex justify-center items-center shadow-lg">
                                <i class="fa-brands fa-line mr-2"></i> ç«‹å³ LINE é å®š
                            </a>
                        </div>
                    </div>
                `;
                container.innerHTML += cardHtml;
            });
        }

        function openGallery(index) {
            const item = currentDisplayedData[index];
            if(!item) return;

            document.getElementById('modal-title').innerText = getValue(item, ['è»Šå', 'åå­—']);
            const modalContainer = document.getElementById('modal-images-container');
            modalContainer.innerHTML = '';

            let mediaItems = [];
            
            // æŠ“å–åœ–ç‰‡/å½±ç‰‡ (è‡ªå‹•åˆä½µè¡¨å–®ä¸Šå‚³æ¬„ä½ + å½±ç‰‡æ¬„ä½)
            const rawMain = getValue(item, ['MainImage', 'Image', 'ç…§ç‰‡', 'åœ–ç‰‡', 'ä¸Šå‚³']);
            if(rawMain) mediaItems = mediaItems.concat(rawMain.split(/[,ï¼Œ\s]+/).filter(u => u.length > 5));
            
            const rawVideo = getValue(item, ['Video', 'å½±ç‰‡', 'è¦–é »']);
            if(rawVideo) mediaItems = mediaItems.concat(rawVideo.split(/[,ï¼Œ\s]+/).filter(u => u.length > 5).map(u => u + "#video"));

            if(mediaItems.length === 0) {
                modalContainer.innerHTML = `<p class="text-white w-full text-center">æš«ç„¡æ›´å¤šç…§ç‰‡</p>`;
            } else {
                modalContainer.innerHTML = mediaItems.map(url => {
                    const isVideo = url.toLowerCase().includes('#video') || url.toLowerCase().endsWith('.mp4');
                    
                    if (isVideo) {
                        const videoId = getDriveId(url);
                        const thumbUrl = convertDriveLink(url);
                        // å½±ç‰‡å‡å°é¢
                        return `
                             <div class="media-item">
                                <div class="video-wrapper">
                                    <div class="video-facade" onclick="loadIframe(this, '${videoId}')">
                                        <img src="${thumbUrl}" onerror="this.src='https://via.placeholder.com/800x600/000000/FFFFFF?text=é»æ“Šæ’­æ”¾å½±ç‰‡'">
                                        <i class="fa-solid fa-play text-white text-6xl absolute opacity-80"></i>
                                    </div>
                                    <div class="video-content bg-black flex justify-center items-center">
                                        <i class="fa-solid fa-spinner fa-spin text-gray-500 text-2xl"></i>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        const imgUrl = convertDriveLink(url);
                        return `
                            <div class="media-item">
                                <img src="${imgUrl}" class="gallery-img">
                            </div>
                        `;
                    }
                }).join('');
            }
            
            // è¨­å®šæŒ‰éˆ•é€£çµ
            const price = getValue(item, ['è»Šåƒ¹', 'åƒ¹æ ¼']);
            const name = getValue(item, ['è»Šå', 'åå­—']);
            const lineMsg = encodeURIComponent(`ä½ å¥½ï¼Œæˆ‘æ­£åœ¨çœ‹ã€Œ${name}ã€çš„ç…§ç‰‡ï¼Œæƒ³é å®šæ–¹æ¡ˆ $${price}/40åˆ†é˜`);
            document.getElementById('modal-line-btn').href = `https://line.me/ti/p/~${myLineId}?text=${lineMsg}`;

            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        window.closeGallery = function() {
            modal.classList.add('hidden');
            document.getElementById('modal-images-container').innerHTML = '';
            document.body.style.overflow = 'auto';
        }
        
        modal.addEventListener('click', (e) => { if(e.target === modal) closeGallery(); });

        searchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase().trim();
            const filtered = profilesData.filter(item => {
                const name = getValue(item, ['è»Šå', 'åå­—']).toLowerCase();
                const body = getValue(item, ['è»Šèº«', 'èº«æ']).toLowerCase();
                const origin = getValue(item, ['è»Šç±', 'åœ°é»']).toLowerCase();
                return name.includes(term) || body.includes(term) || origin.includes(term);
            });
            renderProfiles(filtered);
        });

        init();
    </script>
</body>
</html>
