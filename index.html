<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    <title>ç‚®ç‚®ç‹ | ç³»çµ±ä¿®å¾©ä¸­</title>

    <!-- 1. éŒ¯èª¤æ””æˆªå™¨ (æ”¾åœ¨æœ€ä¸Šé¢ï¼Œä¸€å‡ºéŒ¯é¦¬ä¸Šé¡¯ç¤º) -->
    <style>
        #debug-console {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.9); color: #ff4444;
            padding: 10px; z-index: 9999; font-size: 12px;
            border-bottom: 2px solid red; font-family: monospace;
        }
        /* åŸºç¤æ¨£å¼ (é˜²æ­¢ Tailwind è¼‰å…¥å¤±æ•—æ™‚ç‰ˆé¢å…¨æ¯€) */
        body { background-color: #1a1a1a; color: white; font-family: sans-serif; margin: 0; }
        .card { background: #333; margin-bottom: 15px; border-radius: 8px; overflow: hidden; }
        .card img { width: 100%; height: 300px; object-fit: cover; }
        .p-4 { padding: 15px; }
        .hidden { display: none !important; }
    </style>
    
    <script>
        window.onerror = function(msg, url, line) {
            var console = document.getElementById('debug-console');
            console.style.display = 'block';
            console.innerHTML += "âŒ éŒ¯èª¤: " + msg + " (ç¬¬ " + line + " è¡Œ)<br>";
            return false;
        };
    </script>

    <!-- å¤–éƒ¨è³‡æº -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>

    <!-- é™¤éŒ¯è¨Šæ¯å€ -->
    <div id="debug-console"></div>

    <!-- å°èˆª -->
    <nav class="bg-gray-800 p-4 sticky top-0 z-40 flex justify-between items-center shadow-lg">
        <div class="text-xl font-bold text-yellow-500"><i class="fa-solid fa-crown"></i> ç‚®ç‚®ç‹</div>
        <a href="#" id="navLineBtn" target="_blank" class="bg-white text-black px-4 py-1 rounded-full text-sm font-bold">å®¢æœ</a>
    </nav>

    <!-- å…§å®¹å€ -->
    <div class="max-w-4xl mx-auto p-4">
        
        <!-- æœå°‹ -->
        <div class="mb-6">
            <input type="text" id="searchInput" placeholder="æœå°‹è»Šåã€é—œéµå­—..." 
                   class="w-full p-3 bg-gray-700 border border-gray-600 rounded text-white">
        </div>

        <!-- ç‹€æ…‹æç¤º -->
        <div id="status-msg" class="text-center py-10 text-gray-400">
            <i class="fa-solid fa-circle-notch fa-spin text-2xl"></i><br>
            è³‡æ–™åº«é€£ç·šä¸­...
        </div>

        <!-- åˆ—è¡¨ -->
        <div id="list-area" class="grid grid-cols-1 md:grid-cols-2 gap-4 hidden"></div>
    </div>

    <!-- å½ˆçª— (å…¨è¢å¹•) -->
    <div id="popup" class="fixed inset-0 bg-black z-50 hidden flex-col justify-center items-center">
        <button onclick="closePopup()" class="absolute top-4 left-4 text-white bg-gray-700 px-4 py-2 rounded-full z-50">
            <i class="fa-solid fa-arrow-left"></i> è¿”å›
        </button>
        
        <h2 id="popup-title" class="absolute top-4 w-full text-center font-bold text-lg pointer-events-none mt-2"></h2>

        <div id="popup-content" class="w-full h-full flex overflow-x-auto snap-x snap-mandatory items-center">
            <!-- åœ–ç‰‡æœƒå¡åœ¨é€™è£¡ -->
        </div>

        <div class="absolute bottom-8 w-full px-4">
            <a href="#" id="popup-line-btn" class="block w-full bg-green-600 text-white text-center py-3 rounded-full font-bold shadow-lg">
                ç«‹å³é ç´„
            </a>
        </div>
    </div>

    <script>
        // ğŸ‘‡ è¨­å®šå€ ğŸ‘‡
        const myLineId = "ä½ çš„LINE_ID"; 
        const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSnvM52ixrMGKzLTMMleErStxnyRpFlsPuMUlSc2HdNwIbJhgPrz_eDe7xMgbZv4acLBPK5u9JS6r20/pub?gid=1682452717&single=true&output=csv";
        // -----------------------

        const statusMsg = document.getElementById('status-msg');
        const listArea = document.getElementById('list-area');
        const popup = document.getElementById('popup');
        const debugConsole = document.getElementById('debug-console');
        let allData = [];

        document.getElementById('navLineBtn').href = `https://line.me/ti/p/~${myLineId}`;

        // 1. å•Ÿå‹•
        init();

        function init() {
            // å¼·åˆ¶åŠ ä¸Šæ™‚é–“æˆ³è¨˜ï¼Œé¿å…æ‰‹æ©Ÿå¿«å–èˆŠçš„å£è³‡æ–™
            const url = csvUrl + "&t=" + new Date().getTime();
            
            Papa.parse(url, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    console.log("è®€å–æˆåŠŸ", results);
                    
                    if (results.data.length === 0) {
                        showError("âš ï¸ é€£ç·šæˆåŠŸï¼Œä½† Excel æ˜¯ç©ºçš„ï¼");
                        return;
                    }

                    // é¡¯ç¤ºæŠ“åˆ°çš„æ¬„ä½åç¨± (é™¤éŒ¯ç”¨)
                    const headers = Object.keys(results.data[0]);
                    debugConsole.style.display = 'block';
                    debugConsole.style.background = '#004400'; // ç¶ è‰²ä»£è¡¨æˆåŠŸ
                    debugConsole.style.color = '#fff';
                    debugConsole.style.borderBottom = 'none';
                    debugConsole.innerHTML = "âœ… ç³»çµ±æ­£å¸¸ï¼è®€åˆ°æ¬„ä½: " + headers.join(", ");
                    setTimeout(() => { debugConsole.style.display = 'none'; }, 5000); // 5ç§’å¾Œéš±è—

                    // éæ¿¾è³‡æ–™
                    allData = results.data.filter(item => {
                        return getValue(item, ['è»Šå', 'åå­—', 'å§“å', 'Name']);
                    });

                    if (allData.length > 0) {
                        statusMsg.classList.add('hidden');
                        listArea.classList.remove('hidden');
                        render(allData);
                    } else {
                        showError("âš ï¸ æ‰¾ä¸åˆ°ã€Œè»Šåã€æ¬„ä½ï¼Œè«‹æª¢æŸ¥ Excel æ¨™é¡Œã€‚");
                    }
                },
                error: function(err) {
                    showError("âŒ é€£ç·šå¤±æ•—: " + err.message);
                }
            });
        }

        function showError(msg) {
            statusMsg.innerHTML = `<span class="text-red-500">${msg}</span>`;
            debugConsole.style.display = 'block';
            debugConsole.innerHTML += msg + "<br>";
        }

        // è¼”åŠ©ï¼šè®€å–æ¬„ä½ (è‡ªå‹•å¿½ç•¥å¤§å°å¯«)
        function getValue(item, keys) {
            const allKeys = Object.keys(item);
            for (let target of keys) {
                const found = allKeys.find(k => k.toLowerCase().includes(target.toLowerCase()));
                if (found && item[found]) return item[found].trim();
            }
            return "";
        }

        // è¼”åŠ©ï¼šè½‰æ›åœ–ç‰‡é€£çµ (å¼·åˆ¶ç”¨ç¸®åœ– API)
        function getImgUrl(url) {
            if (!url) return "https://via.placeholder.com/600x400?text=No+Image";
            const match = url.match(/[-\w]{25,}/);
            const id = match ? match[0] : null;
            if (id) return `https://drive.google.com/thumbnail?id=${id}&sz=w1000`;
            return url;
        }

        // 2. æ¸²æŸ“ç•«é¢
        function render(data) {
            listArea.innerHTML = "";
            data.forEach((item, idx) => {
                const name = getValue(item, ['è»Šå', 'åå­—']);
                const price = getValue(item, ['è»Šåƒ¹', 'åƒ¹æ ¼']);
                const age = getValue(item, ['è»Šé½¡', 'å¹´é½¡']) || "--";
                const body = getValue(item, ['è»Šèº«', 'èº«æ']) || "--";
                const origin = getValue(item, ['è»Šç±', 'åœ°é»']) || "å°æ±";
                
                // åœ–ç‰‡è™•ç†
                const rawImg = getValue(item, ['ç…§ç‰‡', 'åœ–ç‰‡', 'Image']);
                const firstImg = rawImg.split(',')[0];
                const imgUrl = getImgUrl(firstImg);

                // ç‹€æ…‹
                const status = getValue(item, ['ç‹€æ…‹', 'Status']);
                const isBusy = status.includes("å¿™") || status.includes("busy");
                const badge = isBusy 
                    ? `<span class="absolute top-2 left-2 bg-red-600 text-white text-xs px-2 py-1 rounded">å¿™ç¢Œä¸­</span>`
                    : `<span class="absolute top-2 left-2 bg-green-600 text-white text-xs px-2 py-1 rounded">å¯é ç´„</span>`;

                const html = `
                    <div class="card relative" onclick="openPopup(${idx})">
                        ${badge}
                        <img src="${imgUrl}" loading="lazy">
                        <div class="p-4 bg-gray-800">
                            <h3 class="text-xl font-bold text-white mb-2">${name}</h3>
                            <div class="flex justify-between text-sm text-gray-400 mb-2">
                                <span>${age}æ­² / ${body}</span>
                                <span>${origin}</span>
                            </div>
                            <div class="text-yellow-400 font-bold text-lg">$${price}</div>
                        </div>
                    </div>
                `;
                listArea.innerHTML += html;
            });
        }

        // 3. å½ˆçª—é‚è¼¯
        window.openPopup = function(idx) {
            // æ¯æ¬¡é‡æ–°æŠ“å–æ­£ç¢ºçš„è³‡æ–™ (é¿å…æœå°‹å¾ŒéŒ¯äº‚)
            // é€™è£¡ç”¨ç°¡å–®çš„å…¨åŸŸæœå°‹ (æ­£å¼ç‰ˆå»ºè­°ç”¨ ID)
            const item = allData[idx]; 
            // æ³¨æ„ï¼šå¦‚æœæœ‰æœå°‹éæ¿¾ï¼Œé€™è£¡ idx æœƒå°ä¸ä¸Šï¼Œç‚ºæ±‚ç©©æš«æ™‚å…ˆé€™æ¨£
            // å¦‚æœæ‚¨æœ‰æœå°‹ï¼Œå»ºè­°ç”¨ render æ™‚æŠŠå®Œæ•´ç‰©ä»¶å­˜å…¥ DOM
            
            // ç°¡å–®ä¿®å¾©ï¼šç›®å‰ä¸æ”¯æ´æœå°‹å¾Œçš„å½ˆçª—ç²¾æº–å®šä½ (å…ˆæ±‚é¡¯ç¤º)
            // ç‚ºäº†è®“æœå°‹å¾Œä¹Ÿèƒ½é»å°ï¼Œæˆ‘å€‘æ”¹ä¸€ä¸‹ render
            // (ç‚ºäº†ä»£ç¢¼ç°¡æ½”ï¼Œé€™ç‰ˆæš«æ™‚ç”¨ idxï¼Œæœå°‹åŠŸèƒ½æœƒé‡ç¹ªï¼Œidx æœƒè®Šï¼Œéœ€è¦æ³¨æ„)
            // ä¿®æ­£ï¼šæˆ‘å€‘æ”¹ç”¨ currentData
            
            const currentItem = currentData[idx];
            if (!currentItem) return;

            document.getElementById('popup-title').innerText = getValue(currentItem, ['è»Šå', 'åå­—']);
            const content = document.getElementById('popup-content');
            content.innerHTML = "";

            // åœ–ç‰‡
            const rawImg = getValue(currentItem, ['ç…§ç‰‡', 'åœ–ç‰‡']);
            if (rawImg) {
                rawImg.split(',').forEach(url => {
                    if (url.trim() == "") return;
                    
                    const div = document.createElement('div');
                    div.className = "min-w-full h-full flex justify-center items-center p-2 relative snap-center";
                    
                    // åµæ¸¬å½±ç‰‡
                    if (url.includes("#video") || url.includes(".mp4")) {
                        // å½±ç‰‡ï¼šç”¨å‡å°é¢ -> é»æ“Šå»å¤–éƒ¨æ’­æ”¾ (æœ€ç©©)
                        const id = url.match(/[-\w]{25,}/)[0];
                        const thumb = `https://drive.google.com/thumbnail?id=${id}&sz=w1000`;
                        const videoLink = `https://drive.google.com/file/d/${id}/preview`; // é è¦½é€£çµ
                        
                        div.innerHTML = `
                            <a href="${videoLink}" target="_blank" class="relative w-full h-full flex justify-center items-center">
                                <img src="${thumb}" class="max-w-full max-h-full object-contain opacity-50">
                                <i class="fa-solid fa-play-circle text-6xl text-white absolute"></i>
                                <p class="absolute bottom-10 text-white text-sm">é»æ“Šæ’­æ”¾å½±ç‰‡</p>
                            </a>
                        `;
                    } else {
                        // åœ–ç‰‡
                        const src = getImgUrl(url);
                        div.innerHTML = `<img src="${src}" class="max-w-full max-h-full object-contain rounded">`;
                    }
                    content.appendChild(div);
                });
            }

            // LINE æŒ‰éˆ•
            const name = getValue(currentItem, ['è»Šå', 'åå­—']);
            const price = getValue(currentItem, ['è»Šåƒ¹', 'åƒ¹æ ¼']);
            document.getElementById('popup-line-btn').href = `https://line.me/ti/p/~${myLineId}?text=æˆ‘æƒ³é ç´„ ${name} ${price}`;

            popup.classList.remove('hidden');
            popup.classList.add('flex');
            document.body.style.overflow = 'hidden';
        }

        window.closePopup = function() {
            popup.classList.add('hidden');
            popup.classList.remove('flex');
            document.body.style.overflow = 'auto';
        }

        // æœå°‹åŠŸèƒ½
        let currentData = [];
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const term = e.target.value.toLowerCase();
            currentData = allData.filter(item => {
                return Object.values(item).join(" ").toLowerCase().includes(term);
            });
            render(currentData);
        });

        // åˆå§‹è³¦å€¼
        setTimeout(() => { currentData = allData; }, 1000);

    </script>
</body>
</html>
