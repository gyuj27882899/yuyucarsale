<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- ğŸŸ¢ é—œéµï¼šè§£æ±º Google Drive åœ–ç‰‡é˜²ç›œéˆå•é¡Œ -->
    <meta name="referrer" content="no-referrer">
    
    <title>ç‚®ç‚®ç‹ | å°æ±å¤–ç´„é¦–é¸</title>
    
    <!-- è¼‰å…¥ Tailwind CSS (æ¨£å¼) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Font Awesome (åœ–ç¤º) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- è¼‰å…¥ PapaParse (è®€å– Excel/CSV ç”¨) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        body { font-family: sans-serif; background-color: #121212; color: #ffffff; }
        
        /* ç³»çµ±ç‹€æ…‹åˆ— (é™¤éŒ¯ç”¨) */
        #system-status { 
            font-size: 14px; padding: 10px; text-align: center; width: 100%; 
            position: fixed; top: 0; left: 0; z-index: 9999; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .status-init { background-color: #f59e0b; color: black; } /* é»ƒè‰²ï¼šåˆå§‹åŒ–ä¸­ */
        .status-ok { background-color: #06C755; color: white; }   /* ç¶ è‰²ï¼šæˆåŠŸ */
        .status-err { background-color: #ef4444; color: white; }  /* ç´…è‰²ï¼šéŒ¯èª¤ */
        
        /* é¿å…é ‚éƒ¨è¢«ç‹€æ…‹åˆ—é®ä½ */
        nav { margin-top: 40px; } 

        /* å¡ç‰‡è¨­è¨ˆ - ç°¡å–®ç©©å®š */
        .profile-card { 
            background-color: #1e1e1e; 
            border-radius: 8px; 
            overflow: hidden; 
            border: 1px solid #333; 
        }
        
        /* åœ–ç‰‡å®¹å™¨ - å¼·åˆ¶å›ºå®šé«˜åº¦ï¼Œé¿å…è·‘ç‰ˆ */
        .img-container {
            width: 100%;
            height: 300px; /* å¼·åˆ¶é«˜åº¦ï¼Œç¢ºä¿æ•´é½Š */
            position: relative;
            background-color: #000;
            overflow: hidden;
        }
        .img-container img {
            width: 100%; 
            height: 100%;
            object-fit: cover; /* å¡«æ»¿å®¹å™¨ */
        }

        /* å½ˆçª—è¨­è¨ˆ */
        #gallery-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.95);
            z-index: 100;
            display: none; /* é è¨­éš±è— */
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            width: 100%;
            height: 60vh;
            display: flex;
            align-items: center;
            overflow-x: auto; /* å·¦å³æ»‘å‹• */
            scroll-snap-type: x mandatory;
            gap: 10px;
            padding: 0 10px;
        }
        
        .modal-item {
            min-width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            scroll-snap-align: center;
            position: relative;
        }
        
        .modal-item img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* å½±ç‰‡ iframe RWD */
        .video-container {
            width: 100%;
            max-width: 800px;
            aspect-ratio: 16/9;
            background: black;
        }
        .video-container iframe {
            width: 100%;
            height: 100%;
        }

        /* æŒ‰éˆ•å„ªåŒ– */
        .btn-line {
            background-color: #06C755; 
            color: white; 
            font-weight: bold; 
            padding: 12px; 
            border-radius: 50px; 
            text-align: center; 
            display: block; 
            width: 100%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

    <!-- 1. ç³»çµ±ç‹€æ…‹åˆ— (ç¢ºèªé€£ç·šç‹€æ³) -->
    <div id="system-status" class="status-init">
        <i class="fa-solid fa-spinner fa-spin"></i> æ­£åœ¨é€£ç·š Google Sheet è³‡æ–™åº«...
    </div>

    <!-- 2. å°èˆªæ¬„ -->
    <nav class="px-4 py-3 bg-gray-900 border-b border-gray-800 flex justify-between items-center sticky top-0 z-40">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-crown text-yellow-500 text-xl"></i>
            <span class="text-xl font-bold">ç‚®ç‚®ç‹</span>
        </div>
        <a href="#" id="nav-line-btn" class="bg-white text-green-600 px-4 py-1.5 rounded-full text-sm font-bold">
            å®¢æœ
        </a>
    </nav>

    <!-- 3. ä¸»è¦å…§å®¹å€ -->
    <main class="max-w-4xl mx-auto px-4 py-6 pb-20">
        
        <!-- æœå°‹ -->
        <div class="mb-6">
            <input type="text" id="search-input" placeholder="ğŸ” æœå°‹è»Šåã€é—œéµå­—..." 
                   class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-yellow-500">
        </div>

        <!-- å¡ç‰‡åˆ—è¡¨å®¹å™¨ -->
        <div id="card-container" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- å…§å®¹æœƒç”± JavaScript è‡ªå‹•ç”¢ç”Ÿ -->
        </div>

        <!-- ç„¡è³‡æ–™æç¤º -->
        <div id="no-data" class="hidden text-center py-20 text-gray-500">
            <p>æš«ç„¡è³‡æ–™ï¼Œæˆ–è®€å–å¤±æ•—ã€‚</p>
        </div>

    </main>

    <!-- 4. é å°¾ -->
    <footer class="text-center py-6 text-gray-600 text-xs">
        &copy; 2025 ç‚®ç‚®ç‹. All Rights Reserved.
    </footer>

    <!-- 5. å½ˆçª— (ç›¸ç°¿/å½±ç‰‡) -->
    <div id="gallery-modal">
        <!-- é—œé–‰æŒ‰éˆ• -->
        <button onclick="closeModal()" class="absolute top-6 left-6 text-white text-lg bg-gray-800 px-4 py-2 rounded-full z-50 border border-gray-600">
            <i class="fa-solid fa-arrow-left"></i> è¿”å›
        </button>

        <!-- æ¨™é¡Œ -->
        <h2 id="modal-title" class="absolute top-6 w-full text-center text-xl font-bold pointer-events-none mt-2 text-white drop-shadow-md"></h2>

        <!-- æ»‘å‹•å…§å®¹å€ -->
        <div id="modal-scroll-area" class="modal-content"></div>

        <!-- åº•éƒ¨æŒ‰éˆ• -->
        <div class="absolute bottom-10 w-full px-6 max-w-md">
            <p class="text-center text-xs text-gray-400 mb-3">å·¦å³æ»‘å‹•æŸ¥çœ‹æ›´å¤š</p>
            <a href="#" id="modal-action-btn" class="btn-line">
                ç«‹å³ LINE é ç´„
            </a>
        </div>
    </div>

    <!-- 6. æ ¸å¿ƒç¨‹å¼ç¢¼ -->
    <script>
        // è¨­å®šå€
        const LINE_ID = "ä½ çš„LINE_ID"; 
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSnvM52ixrMGKzLTMMleErStxnyRpFlsPuMUlSc2HdNwIbJhgPrz_eDe7xMgbZv4acLBPK5u9JS6r20/pub?gid=1682452717&single=true&output=csv";

        // DOM å…ƒç´ 
        const statusEl = document.getElementById('system-status');
        const container = document.getElementById('card-container');
        const modal = document.getElementById('gallery-modal');
        const modalScroll = document.getElementById('modal-scroll-area');
        
        let allData = [];

        // åˆå§‹åŒ–
        function init() {
            document.getElementById('nav-line-btn').href = `https://line.me/ti/p/~${LINE_ID}`;
            
            // å¼·åˆ¶åŠ ä¸Šæ™‚é–“æˆ³è¨˜ï¼Œé¿å…å¿«å–èˆŠè³‡æ–™
            const url = CSV_URL + "&t=" + Date.now();

            Papa.parse(url, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.data && results.data.length > 0) {
                        allData = results.data;
                        statusEl.innerHTML = `âœ… é€£ç·šæˆåŠŸï¼è®€å–åˆ° ${allData.length} ç­†è³‡æ–™`;
                        statusEl.className = "status-ok";
                        
                        // 3ç§’å¾Œè‡ªå‹•éš±è—ç¶ è‰²ç‹€æ…‹åˆ—ï¼Œé¿å…æ“‹ä½è¦–ç·š
                        setTimeout(() => { 
                            statusEl.style.display = 'none'; 
                            document.querySelector('nav').style.marginTop = '0'; 
                        }, 3000); 
                        
                        renderCards(allData);
                    } else {
                        statusEl.innerHTML = "âš ï¸ é€£ç·šæˆåŠŸä½†æ²’æœ‰è³‡æ–™ (Excelæ˜¯ç©ºçš„?)";
                        statusEl.className = "status-err";
                    }
                },
                error: function(err) {
                    statusEl.innerHTML = `âŒ é€£ç·šå¤±æ•—: ${err.message}`;
                    statusEl.className = "status-err";
                }
            });
        }

        // è®€å–æ¬„ä½è¼”åŠ©å‡½å¼ (è‡ªå‹•å¿½ç•¥å¤§å°å¯«)
        function getField(item, keys) {
            const rowKeys = Object.keys(item);
            for (let k of keys) {
                // æ¨¡ç³Šæ¯”å°
                const found = rowKeys.find(rk => rk.toLowerCase().includes(k.toLowerCase()));
                if (found && item[found]) return item[found].trim();
            }
            return "";
        }

        // è½‰æ› Google Drive é€£çµ ID
        function getDriveId(url) {
            if (!url) return null;
            const cleanUrl = url.split('#')[0].split('?')[0]; 
            let match = cleanUrl.match(/\/d\/([a-zA-Z0-9_-]{25,})/);
            if (match) return match[1];
            match = cleanUrl.match(/id=([a-zA-Z0-9_-]{25,})/);
            if (match) return match[1];
            return null;
        }

        // åœ–ç‰‡è½‰æ› (Thumbnail API)
        function convertImg(url) {
            const id = getDriveId(url);
            if (id) return `https://drive.google.com/thumbnail?id=${id}&sz=w1000`;
            return url || "https://via.placeholder.com/600x800?text=No+Image";
        }

        // æ¸²æŸ“å¡ç‰‡
        function renderCards(data) {
            container.innerHTML = "";
            
            // éæ¿¾æ‰æ²’æœ‰åå­—çš„ç„¡æ•ˆè³‡æ–™
            const validData = data.filter(item => getField(item, ['è»Šå', 'åå­—', 'Name']) !== "");

            if (validData.length === 0) {
                document.getElementById('no-data').classList.remove('hidden');
                return;
            } else {
                document.getElementById('no-data').classList.add('hidden');
            }

            validData.forEach((item, index) => {
                const name = getField(item, ['è»Šå', 'åå­—', 'å§“å']);
                const price = getField(item, ['è»Šåƒ¹', 'åƒ¹æ ¼']);
                const age = getField(item, ['è»Šé½¡', 'å¹´é½¡']) || "--";
                const origin = getField(item, ['è»Šç±', 'åœ°é»']) || "å°æ±";
                const body = getField(item, ['è»Šèº«', 'èº«æ']) || "--";
                
                // åœ–ç‰‡è™•ç†
                const rawImg = getField(item, ['ç…§ç‰‡', 'åœ–ç‰‡', 'Image', 'MainImage']);
                const firstImg = rawImg.split(',')[0]; // å–ç¬¬ä¸€å¼µ
                const displayImg = convertImg(firstImg);

                // ç‹€æ…‹è™•ç†
                const status = getField(item, ['ç‹€æ…‹', 'Status', 'ç›®å‰ç‹€æ…‹', 'æ˜¯å¦å¿™ç¢Œ']).toLowerCase();
                const isBusy = ["å¿™", "busy", "no", "x", "æœ‰äº‹", "å”®å‡º"].some(k => status.includes(k));
                const statusBadge = isBusy 
                    ? `<span class="absolute top-3 left-3 bg-red-600 text-white text-xs px-3 py-1 rounded-full font-bold z-10 shadow">å¿™ç¢Œä¸­</span>`
                    : `<span class="absolute top-3 left-3 bg-green-500 text-white text-xs px-3 py-1 rounded-full font-bold z-10 shadow">å¯é ç´„</span>`;

                // å»ºç«‹å¡ç‰‡ HTML
                const html = `
                    <div class="profile-card group" onclick="openModal(${index})">
                        <div class="img-container">
                            ${statusBadge}
                            <img src="${displayImg}" loading="lazy" onerror="this.src='https://via.placeholder.com/400?text=è®€å–å¤±æ•—'">
                            <div class="absolute bottom-0 w-full bg-gradient-to-t from-black to-transparent p-4 pt-10">
                                <h3 class="text-white text-2xl font-bold drop-shadow-md">${name}</h3>
                            </div>
                        </div>
                        <div class="p-4 text-sm text-gray-300 bg-[#2d2d2d]">
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <div class="bg-gray-800 p-1 rounded text-center">è»Šé½¡ï¼š${age}</div>
                                <div class="bg-gray-800 p-1 rounded text-center">è»Šç±ï¼š${origin}</div>
                                <div class="bg-gray-800 p-1 rounded text-center col-span-2">è»Šèº«ï¼š${body}</div>
                            </div>
                            <div class="flex justify-between items-center border-t border-gray-700 pt-3 mt-2">
                                <span class="text-yellow-400 font-bold text-lg">$${price}</span>
                                <span class="text-green-500 font-bold text-sm">é»æ“ŠæŸ¥çœ‹ <i class="fa-solid fa-chevron-right"></i></span>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        // é–‹å•Ÿå½ˆçª—
        window.openModal = function(idx) {
            // ä½¿ç”¨åŸå§‹è³‡æ–™é™£åˆ— (æ³¨æ„ï¼šå¦‚æœæœ‰æœå°‹ï¼Œé€™è£¡è¦æ”¹ç”¨ currentDataï¼Œå…ˆç”¨å…¨åŸŸè®Šæ•¸ç¤ºç¯„)
            // ä¿®æ­£ï¼šé‡æ–°åœ¨ filteredData æ‰¾è³‡æ–™
            const item = currentFilteredData[idx]; 
            if (!item) return;

            const name = getField(item, ['è»Šå', 'åå­—']);
            const price = getField(item, ['è»Šåƒ¹', 'åƒ¹æ ¼']);
            
            document.getElementById('modal-title').innerText = name;
            const lineUrl = `https://line.me/ti/p/~${LINE_ID}?text=${encodeURIComponent('æˆ‘æƒ³é ç´„ ' + name + ' æ–¹æ¡ˆ ' + price)}`;
            document.getElementById('modal-action-btn').href = lineUrl;

            // è™•ç†åª’é«”
            modalScroll.innerHTML = "";
            let mediaList = [];

            // 1. ç…§ç‰‡
            const rawImg = getField(item, ['ç…§ç‰‡', 'åœ–ç‰‡', 'Image']);
            if (rawImg) {
                const urls = rawImg.split(/[,ï¼Œ\s]+/).filter(u => u.length > 5);
                mediaList = mediaList.concat(urls);
            }

            // 2. å½±ç‰‡ (æ”¯æ´ #video å’Œ å°ˆå±¬æ¬„ä½)
            const rawVideo = getField(item, ['å½±ç‰‡', 'Video']);
            if (rawVideo) {
                const vUrls = rawVideo.split(/[,ï¼Œ\s]+/).filter(u => u.length > 5);
                mediaList = mediaList.concat(vUrls.map(u => u.includes('#video') ? u : u + "#video"));
            }

            // æª¢æŸ¥åŸç…§ç‰‡é€£çµæ˜¯å¦æœ‰æ¨™è¨˜å½±ç‰‡
            mediaList = mediaList.map(url => {
               if(url.toLowerCase().includes(".mp4")) return url + "#video";
               return url;
            });

            // ç”¢ç”Ÿå½ˆçª—å…§å®¹
            if (mediaList.length === 0) {
                modalScroll.innerHTML = `<p class="text-white w-full text-center">æš«ç„¡ç…§ç‰‡</p>`;
            } else {
                mediaList.forEach(url => {
                    const div = document.createElement('div');
                    div.className = "modal-item";
                    
                    if (url.toLowerCase().includes("#video")) {
                        // å½±ç‰‡ï¼šç”¨ iframe é è¦½ (æœ€ç©©)
                        const id = getDriveId(url);
                        if(id) {
                            div.innerHTML = `
                                <div class="video-container">
                                    <iframe src="https://drive.google.com/file/d/${id}/preview" allowfullscreen></iframe>
                                </div>`;
                        }
                    } else {
                        // åœ–ç‰‡
                        const imgSrc = convertImg(url);
                        div.innerHTML = `<img src="${imgSrc}" onerror="this.src='https://via.placeholder.com/600?text=Error'">`;
                    }
                    modalScroll.appendChild(div);
                });
            }

            modal.style.display = "flex";
            document.body.style.overflow = "hidden"; // ç¦æ­¢èƒŒæ™¯æ»‘å‹•
        }

        window.closeModal = function() {
            modal.style.display = "none";
            modalScroll.innerHTML = ""; // æ¸…ç©ºå…§å®¹ä»¥åœæ­¢å½±ç‰‡
            document.body.style.overflow = "auto";
        }

        // æœå°‹åŠŸèƒ½
        let currentFilteredData = [];
        const searchInput = document.getElementById('search-input');
        
        searchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase().trim();
            currentFilteredData = allData.filter(item => {
                const allText = Object.values(item).join(" ").toLowerCase();
                return allText.includes(term);
            });
            renderCards(currentFilteredData);
        });

        // å•Ÿå‹•
        init();
        
        // ç¢ºä¿å½ˆçª—é»æ“Šä¹Ÿèƒ½å–å¾—æ­£ç¢ºè³‡æ–™
        setTimeout(() => { currentFilteredData = allData; }, 1000);

    </script>
</body>
</html>
