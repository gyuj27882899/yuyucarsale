<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‚®ç‚®ç‹ - ç³»ç»Ÿè¯Šæ–­ä¸­</title>
    <!-- å¼•å…¥ PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-10 font-mono">

    <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-xl border-4 border-red-500">
        <h1 class="text-3xl font-bold text-red-600 mb-4">ğŸš¨ ç³»ç»Ÿè¯Šæ–­æŠ¥å‘Š</h1>
        <p class="mb-4">è¯·æˆªå›¾è¿™ä¸ªç”»é¢ç»™æˆ‘çœ‹ï¼Œç‰¹åˆ«æ˜¯ä¸‹æ–¹çš„é»‘åº•æ–‡å­—åŒºã€‚</p>

        <div class="mb-6">
            <h2 class="text-xl font-bold mb-2">1. è¿çº¿æµ‹è¯•ï¼š</h2>
            <div id="status" class="text-lg font-bold text-gray-500">æ­£åœ¨è¿çº¿ Google Sheet...</div>
        </div>

        <div class="mb-6">
            <h2 class="text-xl font-bold mb-2">2. æ ä½åç§°æ£€æŸ¥ (æœ€å¸¸å‡ºé”™)ï¼š</h2>
            <p>æˆ‘ä»¬éœ€è¦çš„æ ä½æ˜¯: <span class="bg-gray-200 px-1">Name</span>, <span class="bg-gray-200 px-1">MainImage</span>, <span class="bg-gray-200 px-1">Price</span></p>
            <p class="mt-2">å®é™…è¯»åˆ°çš„æ ä½æ˜¯ï¼š</p>
            <pre id="headers-display" class="bg-black text-yellow-400 p-4 rounded mt-1 overflow-auto">ç­‰å¾…èµ„æ–™ä¸­...</pre>
        </div>

        <div>
            <h2 class="text-xl font-bold mb-2">3. èµ„æ–™è¯»å–æµ‹è¯• (å‰ 3 ç¬”)ï¼š</h2>
            <div id="data-preview" class="space-y-4">
                <!-- èµ„æ–™å°†æ˜¾ç¤ºäºæ­¤ -->
            </div>
        </div>
    </div>

    <script>
        // ğŸ‘‡ ä½ çš„ CSV è¿ç»“
        const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSnvM52ixrMGKzLTMMleErStxnyRpFlsPuMUlSc2HdNwIbJhgPrz_eDe7xMgbZv4acLBPK5u9JS6r20/pub?gid=0&single=true&output=csv";

        const statusDiv = document.getElementById('status');
        const headersDiv = document.getElementById('headers-display');
        const previewDiv = document.getElementById('data-preview');

        // Drive å›¾ç‰‡è½¬æ¢å™¨
        function convertDriveLink(url) {
            if (!url) return "æ— è¿ç»“";
            if (url.includes('drive.google.com')) {
                const idMatch = url.match(/\/d\/(.*?)\/|\?id=(.*?)$/);
                const id = idMatch ? (idMatch[1] || idMatch[2]) : null;
                if (id) return `https://drive.google.com/uc?export=view&id=${id}`;
            }
            return url;
        }

        // å¼€å§‹è¯»å–
        const cacheBuster = (csvUrl.includes('?') ? '&' : '?') + 't=' + new Date().getTime();

        Papa.parse(csvUrl + cacheBuster, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                console.log(results);

                // 1. æ£€æŸ¥æœ‰æ²¡æœ‰è¯»åˆ°ä¸œè¥¿
                if (results.data && results.data.length > 0) {
                    statusDiv.innerHTML = `<span class="text-green-600">âœ… æˆåŠŸè¿çº¿ï¼è¯»å–åˆ° ${results.data.length} ç¬”èµ„æ–™ã€‚</span>`;
                    
                    // 2. æ˜¾ç¤ºæŠ“åˆ°çš„æ ä½åç§°
                    const headers = Object.keys(results.data[0]);
                    headersDiv.innerText = JSON.stringify(headers, null, 2);

                    // æ£€æŸ¥å…³é”®æ ä½
                    const hasName = headers.some(h => h.trim().toLowerCase() === 'name');
                    const hasImage = headers.some(h => h.trim().toLowerCase() === 'mainimage');

                    if (!hasName) headersDiv.innerHTML += '\n\nâŒ ä¸¥é‡é”™è¯¯ï¼šæ‰¾ä¸åˆ° "Name" æ ä½ï¼è¯·æ£€æŸ¥ Google Sheet ç¬¬ä¸€è¡Œæ‹¼å­—ã€‚';
                    if (!hasImage) headersDiv.innerHTML += '\n\nâŒ ä¸¥é‡é”™è¯¯ï¼šæ‰¾ä¸åˆ° "MainImage" æ ä½ï¼è¯·æ£€æŸ¥ Google Sheet ç¬¬ä¸€è¡Œæ‹¼å­—ã€‚';

                    // 3. æ˜¾ç¤ºå‰å‡ ç¬”èµ„æ–™çš„å†…å®¹
                    results.data.slice(0, 3).forEach((item, i) => {
                        const name = item.Name || item.name || "åå­—ä¸ºç©º";
                        const rawImg = item.MainImage || item.mainImage || "";
                        const convImg = convertDriveLink(rawImg);

                        previewDiv.innerHTML += `
                            <div class="border p-4 rounded bg-gray-50 flex gap-4 items-start">
                                <div class="w-24 h-24 bg-gray-300 flex-shrink-0">
                                    <img src="${convImg}" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/100?text=Error'">
                                </div>
                                <div class="overflow-hidden">
                                    <p class="font-bold">ç¬¬ ${i+1} ç¬”: ${name}</p>
                                    <p class="text-sm text-gray-600 truncate">åŸå§‹å›¾ç‰‡è¿ç»“: ${rawImg}</p>
                                    <p class="text-sm text-blue-600 truncate">è½¬æ¢åè¿ç»“: ${convImg}</p>
                                </div>
                            </div>
                        `;
                    });

                } else {
                    statusDiv.innerHTML = `<span class="text-red-600">âŒ è¿çº¿æˆåŠŸï¼Œä½†èµ„æ–™æ˜¯ç©ºçš„ï¼(å¯èƒ½æ˜¯ Google Sheet é‡Œæ²¡èµ„æ–™ï¼Œæˆ–æ˜¯æ²¡å‘å¸ƒæˆ CSV)</span>`;
                }
            },
            error: function(err) {
                statusDiv.innerHTML = `<span class="text-red-600">âŒ è¿çº¿å½»åº•å¤±è´¥ï¼è¯·æ£€æŸ¥ç½‘è·¯æˆ– CSV ç½‘å€ã€‚é”™è¯¯è®¯æ¯: ${err.message}</span>`;
            }
        });
    </script>
</body>
</html>
